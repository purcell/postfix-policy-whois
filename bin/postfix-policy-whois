#!/usr/bin/env ruby

$0='postfix-policy-whois'

PORT = 8787

require 'syslog'

$LOG = Syslog.open($0, Syslog::LOG_PID | Syslog::LOG_PERROR, Syslog::LOG_MAIL)
class << $LOG
  %w(info err notice debug warning crit alert).each do |level|
    define_method level do |*args|
      log(Syslog.const_get("LOG_#{level.upcase}"), *args)
    end
  end
end

require 'resolv'
require 'whois'

def nameserver_for(domain)
  begin
    Resolv::DNS.new.getresource(domain, Resolv::DNS::Resource::IN::NS).name.to_s
  rescue Resolv::ResolvError
    nil
  end
end

def dodgy_dns?(domain)
  if ns = nameserver_for(domain)
    return domain if (ns[".monikerdns.net"] || ns[".name-services.com"] || ns[".registrar-servers.com"])
  else
    parent_domain = domain.scan(/\.(.*)/).flatten.first
    if parent_domain && parent_domain =~ /\./
      return dodgy_dns?(parent_domain)
    end
  end
end

def dodgy_whois?(domain)
  ## TODO: throttle requests
  return Whois.whois(domain).match?(/monikerprivacy|whoisprivacyprotect\.com|whoisguard\.com/)
end

def dodgy?(domain)
  $LOG.info("Checking domain: #{domain}")
  if parent_domain = dodgy_dns?(domain)
    $LOG.info("Suspicious nameserver: #{parent_domain}")
    dodgy = dodgy_whois?(parent_domain)
    $LOG.notice("Private registration: #{parent_domain}") if dodgy
    dodgy
  end
end

require 'socket'
server = TCPServer.new("0.0.0.0", PORT)
$LOG.info("Listening on 0.0.0.0:#{PORT}")

def reject?(policy_input)
  sender = policy_input["sender"]
  unless sender
    $LOG.info("No sender provided")
    return false
  end

  begin
    $LOG.info("Checking sender: #{sender}")
    if dodgy?(sender.scan(/@(.*)/).flatten.first.downcase)
      $LOG.notice("Rejecting mail due to registrar: #{sender}")
      return true
    end
  rescue
    $LOG.err("Error checking registrar: #{$!}")
    return false
  end
end

while true
  Thread.new(server.accept) do |client|
    $LOG.debug("Got connection")
    attr = Hash.new
    while line = client.gets
      break if line == "\n"
      k, v = line.scan(/^(\w+)=(.+?)\s*$/).first
      attr[k] = v if k
    end
    client.write("action=" + (reject?(attr) ? "REJECT" : "DUNNO") + "\n")

    client.write("\n")
    client.close
  end
end
