#!/usr/bin/env ruby

$0='postfix-policy-whois'

PORT = 8787

require 'syslog'

$LOG = Syslog.open($0, Syslog::LOG_PID | Syslog::LOG_PERROR, Syslog::LOG_MAIL)

require 'resolv'
require 'whois'

def nameserver_for(domain)
  begin
    Resolv::DNS.new.getresource(domain, Resolv::DNS::Resource::IN::NS).name.to_s
  rescue Resolv::ResolvError
    nil
  end
end

def dodgy_dns?(domain)
  if ns = nameserver_for(domain)
    return domain if (ns[".monikerdns.net"] || ns[".name-services.com"])
  else
    parent_domain = domain.scan(/\.(.*)/).flatten.first
    if parent_domain && parent_domain =~ /\./
      return dodgy_dns?(parent_domain)
    end
  end
end

def dodgy_whois?(domain)
  ## TODO: throttle requests
  return Whois.whois(domain).match?(/monikerprivacy|whoisprivacyprotect\.com/)
end

def dodgy?(domain)
  $LOG.log(Syslog::LOG_INFO, "Checking domain: #{domain}")
  if parent_domain = dodgy_dns?(domain)
    $LOG.log(Syslog::LOG_INFO, "Suspicious nameserver: #{parent_domain}")
    dodgy = dodgy_whois?(parent_domain)
    $LOG.log(Syslog::LOG_NOTICE, "Private registration: #{parent_domain}") if dodgy
    dodgy
  end
end

require 'socket'
server = TCPServer.new("0.0.0.0", PORT)
$LOG.log(Syslog::LOG_INFO, "Listening on 0.0.0.0:#{PORT}")

while true
  Thread.new(server.accept) do |client|
    $LOG.log(Syslog::LOG_DEBUG, "Got connection")
    attr = Hash.new
    while rp = client.gets
      break if rp == "\n"
      rp2 = rp.scan(/^(\w+)=(.*?)\s*$/).first
      attr[rp2[0]] = rp2[1]
    end

    sender = attr["sender"]
    dodgy = sender && dodgy?(sender.scan(/@(.*)/).flatten.first.downcase)

    if dodgy
      $LOG.log(Syslog::LOG_NOTICE, "Rejecting mail due to registrar: #{sender}")
    end

    client.write("action=" + (dodgy ? "REJECT" : "DUNNO") + "\n")

    client.write("\n")
    client.close
  end
end
